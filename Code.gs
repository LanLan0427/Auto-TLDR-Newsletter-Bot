// ================= è¨­å®šå€ =================
// è«‹å¡«å…¥æ‚¨çš„ Gemini API Key (å¾ Google AI Studio å–å¾—)
const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE';

// è«‹å¡«å…¥æ‚¨çš„ Discord Webhook ç¶²å€
const DISCORD_WEBHOOK_URL = 'YOUR_DISCORD_WEBHOOK_URL_HERE';
// =========================================

function processAllTLDREmails() {
  // ä¸€æ¬¡è™•ç† 3 å°ï¼Œé¿å…è¶…æ™‚
  const threads = GmailApp.search('from:TLDR is:unread', 0, 3); 

  if (threads.length === 0) {
    console.log("ç›®å‰æ²’æœ‰æ–°çš„ TLDR ä¿¡ä»¶");
    return;
  }

  for (const thread of threads) {
    const message = thread.getMessages()[0];
    const subject = message.getSubject();
    const body = message.getPlainBody();
    const sender = message.getFrom().toUpperCase(); 

    // åˆ†é¡é‚è¼¯
    let newsletterType = "ç¶œåˆç§‘æŠ€";
    if (sender.includes("TLDR CRYPTO")) newsletterType = "Web3 èˆ‡å€å¡Šéˆ";
    else if (sender.includes("TLDR AI")) newsletterType = "äººå·¥æ™ºæ…§";
    else if (sender.includes("TLDR DEVOPS")) newsletterType = "DevOps";
    else if (sender.includes("TLDR INFOSEC")) newsletterType = "è³‡å®‰";
    else if (sender.includes("TLDR FINTECH")) newsletterType = "é‡‘èç§‘æŠ€";
    else if (sender.includes("TLDR FOUNDERS")) newsletterType = "å‰µæ¥­";
    else if (sender.includes("TLDR PRODUCT")) newsletterType = "ç”¢å“";
    else if (sender.includes("TLDR DEV")) newsletterType = "è»Ÿé«”é–‹ç™¼";
    else if (sender.includes("TLDR MARKETING")) newsletterType = "è¡ŒéŠ·";
    else if (sender.includes("TLDR DESIGN")) newsletterType = "è¨­è¨ˆ";
    else if (sender.includes("TLDR DATA")) newsletterType = "è³‡æ–™ç§‘å­¸";

    console.log(`è™•ç†ä¿¡ä»¶ï¼š${subject} (${newsletterType})`);

    // å‘¼å« AI ç”¢ç”Ÿ Discord å°ˆç”¨çš„ Markdown å…§å®¹
    const summaryMarkdown = callGeminiAPI(body, newsletterType);
    
    if (summaryMarkdown) {
      // ç™¼é€åˆ° Discord
      sendToDiscord(newsletterType, summaryMarkdown);
      
      // æ¨™è¨˜å·²è®€
      thread.markRead(); 
      
      // å†·å»æ™‚é–“
      console.log("ä¼‘æ¯ 5 ç§’...");
      Utilities.sleep(5000); 
    }
  }
}

function callGeminiAPI(emailContent, type) {
  // ä½¿ç”¨ä½ æ¸¬è©¦æˆåŠŸçš„ 2.5 ç‰ˆæœ¬
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
  
  const promptText = `
    ä½ æ˜¯ä¸€å€‹ ${type} é ˜åŸŸçš„å¿«è¨Šæ©Ÿå™¨äººã€‚è«‹é–±è®€ä»¥ä¸‹ TLDR é›»å­å ±ï¼Œä¸¦ç”¨ã€Œç¹é«”ä¸­æ–‡ã€å¯«ä¸€ä»½é©åˆç™¼åœ¨ Discord çš„ Markdown æ‡¶äººåŒ…ã€‚

    ã€æ’ç‰ˆè¦æ±‚ã€‘
    1. ä½¿ç”¨ Emoji è®“ç‰ˆé¢ç”Ÿå‹• (å¦‚ ğŸš¨, âš¡, ğŸ’¡)ã€‚
    2. ä½¿ç”¨ **ç²—é«”** æ¨™ç¤ºé‡é»ã€‚
    3. é€£çµè«‹ä½¿ç”¨ [é€£çµæ¨™é¡Œ](ç¶²å€) çš„æ ¼å¼ã€‚
    4. å­—æ•¸æ§åˆ¶åœ¨ 1000 å­—ä»¥å…§ã€‚
    5. ä¸è¦ä½¿ç”¨ HTML æ¨™ç±¤ã€‚
    
    ã€è¼¸å‡ºæ ¼å¼ç¯„ä¾‹ã€‘
    **ğŸš¨ é ­æ¢å¤§äº‹**
    * é€™è£¡å¯«é‡é»... [æŸ¥çœ‹æ›´å¤š](URL)
    
    **ğŸ’¡ é—œéµè¶¨å‹¢**
    * é€™è£¡å¯«è¶¨å‹¢...

    ä¿¡ä»¶å…§å®¹ï¼š
    ${emailContent}
  `;

  const payload = {
    "contents": [{
      "parts": [{ "text": promptText }]
    }]
  };

  const options = {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(payload),
    "muteHttpExceptions": true
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const json = JSON.parse(response.getContentText());
    
    if (json.error) {
      console.log("Gemini API Error: " + json.error.message);
      return null;
    }
    return json.candidates[0].content.parts[0].text;

  } catch (e) {
    console.log("Gemini API å‘¼å«å¤±æ•—: " + e.toString());
    return null;
  }
}

// ğŸ”¥ å‚³é€çµ¦ Discord çš„å‡½å¼ (ä¿®å¾© today is not defined)
function sendToDiscord(type, content) {
  // 1. é€™è£¡å®šç¾© todayï¼Œç¢ºä¿ä¸æœƒå ±éŒ¯
  const today = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy/MM/dd");

  // Discord çš„é¡è‰²ä»£ç¢¼
  let color = 5814783; // é è¨­è—è‰²
  if (type.includes("Web3")) color = 15105570; // æ©˜è‰² (Web3)
  else if (type.includes("äººå·¥æ™ºæ…§")) color = 10181046; // ç´«è‰² (AI)
  else if (type.includes("è³‡å®‰")) color = 15158332; // ç´…è‰² (InfoSec)

  const payload = {
    "embeds": [{
      // æ¨™é¡ŒåŠ å…¥æ—¥æœŸ
      "title": `${today} | ğŸ“… æœ€æ–° ${type} æ—¥å ±å½™æ•´`,
      "description": content,
      "color": color,
      "footer": {
        "text": "Generated by Gemini AI â€¢ TLDR Bot"
      },
      "timestamp": new Date().toISOString()
    }]
  };

  const options = {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(payload)
  };

  try {
    UrlFetchApp.fetch(DISCORD_WEBHOOK_URL, options);
    console.log(`[${today}] å·²ç™¼é€è‡³ Discord`);
  } catch (e) {
    console.log("Discord ç™¼é€å¤±æ•—: " + e.toString());
  }
}
